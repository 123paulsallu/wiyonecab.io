<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Driver Dashboard — WiYone Cab</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
      body{font-family:'Quicksand',Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:24px}
      .wrap{max-width:960px;margin:0 auto}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
      .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,.06)}
      h1{margin:0 0 6px}
      ul{list-style:none;padding-left:0}
      li{padding:10px;border-bottom:1px solid #f1f5f9}
      .btn{background:#0078d4;color:#fff;padding:8px 12px;border-radius:6px;text-decoration:none}
      .small{color:#6b7280;font-size:13px}
      form.inline{display:inline}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Driver Dashboard</h1>
          <div class="small">Welcome, {{ request.user.username }}</div>
        </div>
        <div>
          <a class="btn" href="/accounts/logout/">Logout</a>
        </div>
      </header>

      <section class="card" style="margin-bottom:12px">
        <h2 style="margin:0 0 8px">Available rides</h2>
        <ul>
          {% for r in available %}
            <li data-ride-id="{{ r.id }}">{{ r.origin }} → {{ r.destination }} — <form method="post" action="/api/rides/{{ r.id }}/accept/" class="inline">{% csrf_token %}<button class="btn" type="submit">Accept</button></form></li>
          {% empty %}
            <li class="small">No available rides.</li>
          {% endfor %}
        </ul>
      </section>

      <section class="card">
        <h2 style="margin:0 0 8px">Assigned to you</h2>
        <ul>
          {% for r in assigned %}
            <li data-ride-id="{{ r.id }}">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <strong>{{ r.origin }} → {{ r.destination }}</strong>
                  <div class="small">Status: <span class="status-badge">{{ r.status }}</span> • Requested: {{ r.requested_at }}</div>
                </div>
                <div>
                  {% if r.status != 'completed' %}
                    <form method="post" action="/api/rides/{{ r.id }}/complete/" class="inline">{% csrf_token %}<button class="btn" type="submit" onclick="return confirm('Mark this ride completed?');">Mark completed</button></form>
                  {% else %}
                    <div class="small">Completed: {{ r.completed_at }}</div>
                  {% endif %}
                </div>
              </div>
            </li>
          {% empty %}
            <li class="small">No assigned rides.</li>
          {% endfor %}
        </ul>
      </section>
      <script>
        (function(){
          const items = document.querySelectorAll('li[data-ride-id]');
          if(items.length === 0) return;
          async function fetchStatus(id){
            try{const res = await fetch(`/api/rides/${id}/status/`, {credentials: 'same-origin'}); if(!res.ok) return null; return await res.json();}catch(e){return null}
          }
          async function refresh(){
            for(const el of items){
              const id = el.getAttribute('data-ride-id');
              const data = await fetchStatus(id);
              if(!data) continue;
              const badge = el.querySelector('.status-badge');
              if(badge) badge.textContent = data.status;
            }
          }
          refresh(); setInterval(refresh, 10000);
        })();
      </script>
    </div>
  </body>
</html>
